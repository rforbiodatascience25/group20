---
title: "lab07_assignment"
format: html
editor: visual
---

# Load Libraries

```{r}
#| message: false
library("tidyverse")
library("broom")
library("cowplot")
library("ggrepel")
```

# Load data

We will in this mini-report a biopsy dataset from the university of Wisconsin Hospitals. A set of 699 patients and a sample from nine variables with a scoring of 1-10 seen in the figure below, along with the outcome of the tumor.

```{r}
#| message: false
biopsy <- read_csv("https://wilkelab.org/classes/SDS348/data_sets/biopsy.csv")
```

# Data Wrangle

```{r}
pca_fit <- biopsy |>
  select(where(is.numeric)) |>
  prcomp(scale = TRUE)
```

```{r}
pca_fit_score <- pca_fit |>
  augment(biopsy) |>
  rename_with(~str_remove(.x, ".fitted"), starts_with(".fitted"))
```

# Data Description

This breast cancer database was obtained from the University of Wisconsin Hospitals, It consists of assessed biopsies of breast tumours for 699 patients; each of nine attributes has been scored on a scale of 1 to 10, and the outcome is also known. It has 10 collumns and 683 rows.

```{r}
biopsy |> head(5)
```

# Analysis

## PC coordinates

As we have 9 principal components we will first setup a function for comparative plotting of the PCA space.

```{r}
plot_pc <- function(pc_x, pc_y) {
  ggplot(pca_fit_score, aes_string(x = pc_x, y = pc_y, color = "outcome")) +
    geom_point(size = 1.5, alpha = 0.8) +
    scale_color_manual(
      values = c(malignant = "salmon", benign = "skyblue")
    ) +
    theme_half_open(12) + background_grid() +
    labs(title = paste("Principal component",
                       str_remove(pc_x, "PC"),
                       "vs",
                       "Principal component",
                       str_remove(pc_y, "PC")),
         x = paste(pc_x),
         y = paste(pc_y),
         color = "Tumor outcome")
}
```

Now we can compare the first three principal components to each other.

```{r, fig.height = 10, fig.align='center', fig.width=12}
PC1vPC2 <- plot_pc("PC1", "PC2") + coord_fixed(xlim = c(-5,5), ylim = c(-3,5))
PC1vPC3 <- plot_pc("PC1", "PC3") + coord_fixed(xlim = c(-5,5), ylim = c(-3,5))
PC2vPC3 <- plot_pc("PC2", "PC3") + coord_fixed(xlim = c(-5,5), ylim = c(-3,5))

plot_list <- list(PC1vPC2, PC1vPC3, PC2vPC3)

plot_grid(plotlist = plot_list, nrow = 3)
```

Already here based on the coordinates we can see that principal component 1 has significant influence on the tumour outcome, as would be expected of the principal component with the higest variance which we will compare later.

## Variance explained by each PC

Here, weâ€™ll plot the variance explained by each PC.

```{r}
pca_fit |>
  tidy(matrix = "eigenvalues") |>
  ggplot(aes(PC, percent)) +
  geom_col(fill = "lightblue", 
           alpha = 0.8, 
           color = "black") +
  scale_x_continuous(breaks = 1:9) +
  scale_y_continuous(
    labels = scales::percent_format(),
    expand = expansion(mult = c(0, 0.01))
  ) +
  theme_minimal_hgrid(12) +
  labs(y = "Percent variance explained")
```

The first component captures 65% of the variation in the data and, as we can see from the first plot in this post, nicely separates the benign samples from the malignant samples.

## Loading Analysis

Now let's look at which of the nine biopsy measurements actually drive the principal components. The loadings show us how much each variable contributes to each PC, helping us understand what the components actually represent.

```{r}
pca_fit |>
  tidy(matrix = "rotation") |>
  pivot_wider(names_from = "PC",
              names_prefix = "PC",
              values_from = "value") |>
  ggplot(aes(PC1, PC2)) +
  geom_segment(aes(xend = 0, yend = 0), 
               arrow = arrow(ends = "first", length = grid::unit(8, "pt")),
               color = "steelblue", linewidth = 0.8) +
  geom_text_repel(aes(label = column), 
                  size = 3.5,
                  max.overlaps = 20, 
                  hjust = 1,
                  vjust = 1) +
  theme_minimal_grid() +
  labs(x = "PC1 Loading",
       y = "PC2 Loading")
```

All nine measurements load strongly and similarly on PC1, meaning malignant tumors tend to score high across all features together. This is why PC1 effectively separates benign from malignant tumors. PC2 is mainly driven by mitoses, capturing additional variation in cell division rates.
